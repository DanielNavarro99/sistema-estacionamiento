<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <title>Monitor de Salida</title>
    <style>
        body { background-color: #e9ecef; }
        .card-display {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .data-label { color: #6c757d; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
        .data-value { font-size: 2.5rem; font-weight: 800; color: #212529; }
        
        #cronometro {
            font-family: 'Courier New', monospace;
            font-size: 4.5rem;
            font-weight: bold;
            color: #0d6efd;
            line-height: 1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h2 class="text-center mb-4 text-dark fw-bold">üìü Monitor de Cobro</h2>

        <div class="card card-display p-5 mb-4 text-center">
            
            <div class="row mb-4">
                <div class="col-md-6 border-end">
                    <div class="data-label">Placa del Veh√≠culo</div>
                    <div id="lblPlaca" class="data-value text-uppercase">‚Äî</div>
                </div>
                <div class="col-md-6">
                    <div class="data-label">Tipo de Veh√≠culo</div>
                    <div id="lblTipo" class="data-value text-primary">‚Äî</div>
                </div>
            </div>

            <hr>

            <div class="my-4">
                <div class="data-label mb-2">Tiempo Transcurrido</div>
                <div id="cronometro">00:00:00</div>
                <div id="lblEstado" class="mt-2 badge bg-secondary fs-6">Cargando...</div>
            </div>

            <div class="d-grid gap-2">
                <button id="btnParar" class="btn btn-secondary btn-lg py-3 fw-bold shadow" onclick="clickParar()" disabled>
                    ESPERANDO VEH√çCULO...
                </button>

                <button id="btnPdf" class="btn btn-primary btn-lg py-3 fw-bold shadow" onclick="generarTicketPDF()" style="display: none;">
                    üñ®Ô∏è DESCARGAR TICKET (PDF)
                </button>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white fw-bold">Detalle Financiero</div>
            <div class="card-body p-0">
                <table id="tablaVehiculo" class="table table-striped mb-0 text-center align-middle">
                    <thead>
                        <tr>
                            <th>Hora Entrada</th>
                            <th>Hora Salida</th>
                            <th>Total Horas</th>
                            <th>Costo Final</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="4">Sin datos recientes</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let intervaloTimer;
        let idRegistroActual = null;
        let datosParaTicket = null; 

        document.addEventListener("DOMContentLoaded", () => {
            obtenerUltimoRegistro();
            setInterval(obtenerUltimoRegistro, 3000); 
        });

        // 1. COBRAR (PARAR TIEMPO)
        function clickParar() {
            if (!idRegistroActual) return;

            Swal.fire({
                title: '¬øCobrar Ticket?',
                text: "Se detendr√° el tiempo y calcular√° el costo.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'S√≠, Cobrar'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    clearInterval(intervaloTimer); 

                    try {
                        const res = await fetch(`http://localhost:3000/api/registros/${idRegistroActual}/salida`, {
                            method: "PUT",
                            headers: { "Content-Type": "application/json" }
                        });

                        if (res.ok) {
                            await obtenerUltimoRegistro(); 
                            Swal.fire('¬°Listo!', 'Cobro realizado. Puedes imprimir el ticket.', 'success');
                        } else {
                            Swal.fire('Error', 'No se pudo cerrar', 'error');
                        }
                    } catch (e) { console.error(e); }
                }
            });
        }

        // 2. GENERAR PDF DIRECTO (SIN PREGUNTAS)
        function generarTicketPDF() {
            if (!datosParaTicket) return;

            // Nombre por defecto para que no salga vac√≠o
            const clienteFinal = "Cliente General"; 

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: "portrait",
                unit: "mm",
                format: [80, 150] 
            });

            // Dise√±o del Ticket
            doc.setFont("courier", "bold");
            doc.setFontSize(14);
            doc.text("ESTACIONAMIENTO", 40, 10, { align: "center" });
            
            doc.setFontSize(10);
            doc.setFont("courier", "normal");
            doc.text("--------------------------------", 40, 15, { align: "center" });

            const fechaHoy = new Date().toLocaleString("es-MX");
            doc.text(fechaHoy, 40, 20, { align: "center" });

            doc.text("--------------------------------", 40, 25, { align: "center" });

            let y = 35; 
            doc.text(`PLACA:   ${datosParaTicket.placa}`, 5, y); y += 5;
            doc.text(`TIPO:    ${datosParaTicket.tipo_vehiculo}`, 5, y); y += 5;
            
            doc.text("--------------------------------", 40, y); y += 5;

            doc.text(`ENTRADA: ${formatearHora(datosParaTicket.hora_entrada)}`, 5, y); y += 5;
            doc.text(`SALIDA:  ${formatearHora(datosParaTicket.hora_salida)}`, 5, y); y += 5;
            
            const horas = parseFloat(datosParaTicket.horas_totales).toFixed(2);
            doc.text(`TIEMPO:  ${horas} HRS`, 5, y); y += 8;

            // TOTAL GRANDE
            doc.setFontSize(16);
            doc.setFont("courier", "bold");
            const total = parseFloat(datosParaTicket.costo_total).toFixed(2);
            doc.text(`TOTAL: $${total}`, 40, y, { align: "center" });

            y += 10;
            doc.setFontSize(10);
            doc.setFont("courier", "normal");
            doc.text("¬°Gracias por su visita!", 40, y, { align: "center" });

            // Descarga autom√°tica
            doc.save(`Ticket_${datosParaTicket.placa}.pdf`);
        }

        // 3. OBTENER DATOS
        async function obtenerUltimoRegistro() {
            try {
                const res = await fetch("http://localhost:3000/api/registros/ultimo");
                const data = await res.json();
                actualizarInterfaz(data);
            } catch (error) { console.log("Esperando conexi√≥n..."); }
        }

        // 4. ACTUALIZAR PANTALLA
        function actualizarInterfaz(reg) {
            const btnOut = document.getElementById("btnParar");
            const btnPdf = document.getElementById("btnPdf");
            const lblPlaca = document.getElementById("lblPlaca");
            const lblTipo = document.getElementById("lblTipo");
            const lblEstado = document.getElementById("lblEstado");
            const tbody = document.querySelector("#tablaVehiculo tbody");

            if (!reg) {
                lblPlaca.innerText = "‚Äî";
                return;
            }

            datosParaTicket = reg; // Guardar para PDF

            const placa = reg.placa || reg.Placa || "SIN PLACA";
            const tipo = reg.tipo_vehiculo || "Automovil"; 
            const estado = reg.estado || "finalizado";

            lblPlaca.innerText = placa;
            lblTipo.innerText = tipo;

            if (estado === 'activo') {
                idRegistroActual = reg.id;
                
                btnOut.disabled = false;
                btnOut.innerText = "‚èπ FINALIZAR Y COBRAR";
                btnOut.className = "btn btn-danger btn-lg py-3 fw-bold shadow";
                btnOut.style.display = "block";
                
                btnPdf.style.display = "none"; 

                lblEstado.innerText = "‚è±Ô∏è EN CURSO";
                lblEstado.className = "mt-2 badge bg-success fs-6";

                iniciarContador(reg.hora_entrada);
            } else {
                idRegistroActual = null;
                
                btnOut.disabled = true;
                btnOut.style.display = "none"; 
                
                btnPdf.style.display = "block"; // Mostrar bot√≥n PDF

                lblEstado.innerText = "üèÅ FINALIZADO";
                lblEstado.className = "mt-2 badge bg-dark fs-6";

                clearInterval(intervaloTimer);
                document.getElementById("cronometro").innerText = "00:00:00";
            }

            const horasNum = reg.horas_totales ? parseFloat(reg.horas_totales) : 0;
            const costoNum = reg.costo_total ? parseFloat(reg.costo_total) : 0;

            tbody.innerHTML = `
                <tr>
                    <td>${formatearHora(reg.hora_entrada)}</td>
                    <td>${reg.hora_salida ? formatearHora(reg.hora_salida) : "En curso..."}</td>
                    <td class="fw-bold">${reg.horas_totales ? horasNum.toFixed(2) + " hrs" : "..."}</td>
                    <td class="text-success fw-bold fs-4">
                        ${reg.costo_total ? "$" + costoNum.toFixed(2) : "$0.00"}
                    </td>
                </tr>
            `;
        }

        function iniciarContador(fechaEntrada) {
            if(intervaloTimer) clearInterval(intervaloTimer);
            const inicio = new Date(fechaEntrada).getTime();
            intervaloTimer = setInterval(() => {
                const ahora = new Date().getTime();
                const diff = ahora - inicio;
                if(diff < 0) return;
                const h = Math.floor(diff / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                document.getElementById("cronometro").innerText = `${pad(h)}:${pad(m)}:${pad(s)}`;
            }, 1000);
        }
        function pad(n) { return n < 10 ? '0' + n : n; }
        function formatearHora(f) { return new Date(f).toLocaleTimeString('es-MX', {hour:'2-digit', minute:'2-digit'}); }
    </script>
</body>
</html>